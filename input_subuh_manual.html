<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Lapor Subuh</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { max-width:650px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
label { font-weight:bold; display:block; margin-top:10px; }
select,input,button { width:100%; padding:8px; margin-top:5px; }
button { background:#2e7d32; color:white; border:none; margin-top:15px; cursor:pointer; }
.notice { background:#fff3cd; color:#856404; padding:8px; border-radius:4px; margin-top:10px; display:none; }
.error { color:#c62828; margin-top:10px; }
ul { padding-left:18px; }
hr { margin:20px 0; }
</style>
</head>
<body>

<div class="card">
<h2 align="center">Lapor Subuh</h2>

<label>Lembaga</label>
<select id="lembaga"></select>

<label>Kelas</label>
<select id="kelas"></select>

<label>Rombel</label>
<select id="rombel"></select>

<label>Nama Siswa</label>
<select id="siswa"></select>

<label>Tanggal</label>
<input type="date" id="tanggal">


<label>Pukul</label>
<input type="time" id="jam" value="04:00" readonly>



<input type="hidden" id="nilai" value="5">


<div id="notice" class="notice"></div>
<div id="error" class="error"></div>


<button onclick="kirim()">Kirim Laporan</button>

<hr>
<h3>Riwayat Siswa</h3>
<div id="history">Pilih siswa</div>

<h3>Total Nilai</h3>
<div id="total">0</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const lembagaEl = document.getElementById("lembaga");
const kelasEl = document.getElementById("kelas");
const rombelEl = document.getElementById("rombel");
const siswaEl = document.getElementById("siswa");
const tanggalEl = document.getElementById("tanggal");
const jamEl = document.getElementById("jam");
const noticeEl = document.getElementById("notice");
const errorEl = document.getElementById("error");
const historyEl = document.getElementById("history");
const totalEl = document.getElementById("total");

const now = new Date();
tanggalEl.value = now.toISOString().split("T")[0];


function selectedText(el){
  return el.options[el.selectedIndex]?.text || "";
}

/* LOAD LEMBAGA */
async function loadLembaga(){
  lembagaEl.innerHTML="<option value=''>Pilih</option>";
  const snap = await getDocs(collection(db,"lembaga"));
  let data=[];
  snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,'id'));
  data.forEach(d=>{
    lembagaEl.innerHTML+=`<option value="${d.id}">${d.nama}</option>`;
  });
}
loadLembaga();

/* PILIH KELAS */
lembagaEl.onchange = async ()=>{
  kelasEl.innerHTML="<option value=''>Pilih</option>";
  rombelEl.innerHTML="<option value=''>Pilih</option>";
  siswaEl.innerHTML="<option value=''>Pilih</option>";

  const snap = await getDocs(
    query(collection(db,"kelas"), where("lembagaId","==",lembagaEl.value))
  );

  let data=[];
  snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,'id',{numeric:true}));
  data.forEach(k=>{
    kelasEl.innerHTML+=`<option value="${k.id}">${k.nama}</option>`;
  });
};

/* PILIH ROMBEL */
kelasEl.onchange = async ()=>{
  rombelEl.innerHTML="<option value=''>Pilih</option>";
  siswaEl.innerHTML="<option value=''>Pilih</option>";

  const snap = await getDocs(
    query(collection(db,"rombel"), where("kelasId","==",kelasEl.value))
  );

  let data=[];
  snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,'id',{numeric:true}));
  data.forEach(r=>{
    rombelEl.innerHTML+=`<option value="${r.id}">${r.nama}</option>`;
  });
};

/* PILIH SISWA */
rombelEl.onchange = async ()=>{
  siswaEl.innerHTML="<option value=''>Pilih</option>";

  const snap = await getDocs(
    query(collection(db,"siswa"), where("rombelId","==",rombelEl.value))
  );

  let data=[];
  snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,'id'));
  data.forEach(s=>{
    siswaEl.innerHTML+=`<option value="${s.id}">${s.nama}</option>`;
  });
};

siswaEl.onchange = loadHistory;

async function loadHistory(){
  historyEl.innerHTML="Memuat...";
  totalEl.innerText="0";

  const snap = await getDocs(
    query(collection(db,"lapor_subuh"), where("siswaId","==",siswaEl.value))
  );

  let data=[];
  snap.forEach(d=>data.push(d.data()));
  data.sort((a,b)=>b.tanggal.localeCompare(a.tanggal));

  let total=0, html="<ul>";
  data.forEach(r=>{
    html+=`<li>${r.tanggal} ${r.jam} ‚Üí ${r.nilai}</li>`;
    total+=r.nilai;
  });
  html+="</ul>";

  historyEl.innerHTML=data.length?html:"Belum ada laporan";
  totalEl.innerText=total;
}

function validSubuh(){
  return jamEl.value>="03:00" && jamEl.value<="05:00";
}

window.kirim = async ()=>{
  errorEl.innerText="";
  noticeEl.style.display="none";

  if(!siswaEl.value){
    errorEl.innerText="Pilih siswa";
    return;
  }

  if(!validSubuh()){
    noticeEl.innerText="‚è∞ Hanya jam 03.00 ‚Äì 05.00";
    noticeEl.style.display="block";
    return;
  }

  const cek = await getDocs(
    query(collection(db,"lapor_subuh"),
      where("siswaId","==",siswaEl.value),
      where("tanggal","==",tanggalEl.value))
  );

  if(!cek.empty){
    noticeEl.innerText="üôè Sudah lapor hari ini";
    noticeEl.style.display="block";
    return;
  }

  await addDoc(collection(db,"lapor_subuh"),{
    lembagaId: lembagaEl.value,
    lembagaNama: selectedText(lembagaEl),
    kelasId: kelasEl.value,
    kelasNama: selectedText(kelasEl),
    rombelId: rombelEl.value,
    rombelNama: selectedText(rombelEl),
    siswaId: siswaEl.value,
    nama: selectedText(siswaEl),
    tanggal: tanggalEl.value,
    bulan: tanggalEl.value.slice(0,7),
    jam: jamEl.value,
    nilai: 5,
    dibuat: serverTimestamp()
  });

  loadHistory();
  alert("‚úÖ Laporan berhasil");
};
</script>
</body>
</html>
