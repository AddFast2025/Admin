<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Lapor Subuh</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.card{max-width:650px;margin:auto;background:#fff;padding:20px;border-radius:8px;position:relative}
label{font-weight:bold;display:block;margin-top:10px}
select,input,button{width:100%;padding:8px;margin-top:5px}
button{background:#2e7d32;color:#fff;border:none;margin-top:15px;cursor:pointer}
button:disabled{background:#9e9e9e;cursor:not-allowed}
.notice{background:#fff3cd;color:#856404;padding:8px;border-radius:4px;margin-top:10px;display:none}
.error{color:#c62828;margin-top:10px}
ul{padding-left:18px}
hr{margin:20px 0}

/* Gate */
#gate{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;align-items:center;justify-content:center}
#gateBox{width:300px;padding:20px;text-align:center;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.15)}

#btnGanti{
  position:absolute;top:10px;right:10px;
  width:34px;height:34px;border-radius:50%;
  background:#1976d2;font-size:18px;line-height:34px;padding:0;
}

.logo-header{
  text-align:center;
  margin-bottom:10px;
}
.logo-header img{
  max-height:90px;
  max-width:100%;
  object-fit:contain;
}


#pengumuman{
  display:none;
}

</style>
</head>
<body>


<!-- GATE -->
<div id="gate">
  <div id="gateBox">
    <h3>üîê Kode Lembaga</h3>
    <input id="kodeLembaga" placeholder="Masukkan kode lembaga">
    <button id="btnMasuk">Masuk</button>
    <div id="gateMsg" class="error"></div>
  </div>
</div>

<div class="card">
  <button id="btnGanti" title="Ganti Lembaga">üè´</button>

  <div class="logo-header" id="logoHeader" style="display:none">
  <img id="logoLembaga">
</div>


  
<h2 align="center">Lapor Subuh</h2>
<button id="pengumuman" onclick="location.href='pengumuman.html'"> Pengumuman </button>

  <label>Lembaga</label>
  <select id="lembaga" disabled></select>

  <label>Kelas</label>
  <select id="kelas"></select>

  <label>Rombel</label>
  <select id="rombel"></select>

  <label>Nama Siswa</label>
  <select id="siswa"></select>

  <input type="hidden" id="tanggal">
  <input type="hidden" id="jam">

  <div id="notice" class="notice"></div>
  <div id="error" class="error"></div>

  <button id="btnKirim">Kirim Laporan</button>



  <hr>
  <h3>Riwayat Siswa</h3>
  <div id="history">Pilih siswa</div>

  <h3>Total Nilai</h3>
  <div id="total">0</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, query, where,
  getDocs, doc, getDoc, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain:"datasiswa-c10f4.firebaseapp.com",
  projectId:"datasiswa-c10f4"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* ELEMENT */
const gate=document.getElementById("gate");
const gateMsg=document.getElementById("gateMsg");
const kodeEl=document.getElementById("kodeLembaga");
const btnMasuk=document.getElementById("btnMasuk");
const btnGanti=document.getElementById("btnGanti");

const lembagaEl=document.getElementById("lembaga");
const kelasEl=document.getElementById("kelas");
const rombelEl=document.getElementById("rombel");
const siswaEl=document.getElementById("siswa");

const tanggalEl=document.getElementById("tanggal");
const jamEl=document.getElementById("jam");

const noticeEl=document.getElementById("notice");
const errorEl=document.getElementById("error");
const historyEl=document.getElementById("history");
const totalEl=document.getElementById("total");
const btnKirim=document.getElementById("btnKirim");


const logoHeader = document.getElementById("logoHeader");
const logoImg = document.getElementById("logoLembaga");

function driveThumb(url){
  if(!url) return "";
  const m = url.match(/id=([^&]+)/);
  return m ? `https://drive.google.com/thumbnail?id=${m[1]}&sz=w600` : "";
}

async function loadLogo(lembagaId){
  const ref = doc(db,"lembaga",lembagaId);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;

  const logo = snap.data().logo;
  if(!logo) return;

  const thumb = driveThumb(logo);
  if(!thumb) return;

  logoImg.src = thumb;
  logoHeader.style.display = "block";
}





/* WAKTU */
const now=new Date();
tanggalEl.value=now.toLocaleDateString("en-CA");
jamEl.value=now.toTimeString().slice(0,5);
const textOf=el=>el.options[el.selectedIndex]?.text||"";
const validSubuh=()=>jamEl.value>="03:00"&&jamEl.value<="05:00";

/* =====================
   COOLDOWN (DIKEMBALIKAN)
===================== */
const COOLDOWN_KEY="cooldownUntil";
let timer=null;

function startCooldown(sec){
  localStorage.setItem(COOLDOWN_KEY,Date.now()+sec*1000);
  runCooldown();
}

function runCooldown(){
  const until=Number(localStorage.getItem(COOLDOWN_KEY));
  if(!until) return;

  const sisa=Math.ceil((until-Date.now())/1000);
  if(sisa<=0){
    localStorage.removeItem(COOLDOWN_KEY);
    btnKirim.disabled=false;
    btnKirim.innerText="Kirim Laporan";
    return;
  }
  btnKirim.disabled=true;
  btnKirim.innerText=`Kamu Sudah Mengirim Laporan`;
  clearInterval(timer);
  timer=setInterval(runCooldown,1000);
}

/* =====================
   GATE ‚Äì TIDAK CASE SENSITIF
===================== */
btnMasuk.onclick=async()=>{
  gateMsg.innerText="";
  const inputKode=kodeEl.value.trim().toLowerCase();
  if(!inputKode){
    gateMsg.innerText="Masukkan kode";
    return;
  }

  const snap=await getDocs(
    query(collection(db,"lembaga"),where("aktif","==",true))
  );

  let found=null;
  snap.forEach(d=>{
    if((d.data().kode||"").toLowerCase()===inputKode){
      found={id:d.id,data:d.data()};
    }
  });

  if(!found){
    gateMsg.innerText="Kode tidak ditemukan";
    return;
  }

  lembagaEl.innerHTML=
    `<option value="${found.id}" selected>${found.data.nama}</option>`;
  lembagaEl.disabled=true;

  localStorage.setItem("lembagaId",found.id);
  localStorage.setItem("lembagaNama",found.data.nama);

  gate.style.display="none";
  lembagaEl.dispatchEvent(new Event("change"));
loadLogo(found.id);
};

/* AUTO LOGIN + COOLDOWN */
window.addEventListener("load",()=>{
  const id=localStorage.getItem("lembagaId");
  const nm=localStorage.getItem("lembagaNama");
  if(id&&nm){
    lembagaEl.innerHTML=`<option value="${id}" selected>${nm}</option>`;
    lembagaEl.disabled=true;
    gate.style.display="none";
    lembagaEl.dispatchEvent(new Event("change"));
loadLogo(id);
  }
  runCooldown();
});

/* GANTI LEMBAGA */
btnGanti.onclick=()=>{
  if(confirm("Apakah Anda ingin mengganti lembaga?")){
   localStorage.removeItem("lembagaId");
localStorage.removeItem("lembagaNama");
    location.reload();
  }
};

/* LOAD KELAS */
lembagaEl.onchange=async()=>{
  kelasEl.innerHTML="<option value=''>Pilih</option>";
  rombelEl.innerHTML="<option value=''>Pilih</option>";
  siswaEl.innerHTML="<option value=''>Pilih</option>";

  const snap=await getDocs(
    query(collection(db,"kelas"),where("lembagaId","==",lembagaEl.value))
  );
  let data=[];
  snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>parseInt(a.nama)-parseInt(b.nama));
  data.forEach(k=>kelasEl.innerHTML+=
    `<option value="${k.id}">${k.nama}</option>`
  );
};

/* ROMBEL */
kelasEl.onchange=async()=>{
  rombelEl.innerHTML="<option value=''>Pilih</option>";
  siswaEl.innerHTML="<option value=''>Pilih</option>";

  const snap=await getDocs(
    query(collection(db,"rombel"),where("kelasId","==",kelasEl.value))
  );
  let data=[];
  snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,"id"));
  data.forEach(r=>rombelEl.innerHTML+=
    `<option value="${r.id}">${r.nama}</option>`
  );
};

/* SISWA */
rombelEl.onchange=async()=>{
  siswaEl.innerHTML="<option value=''>Pilih</option>";
  const snap=await getDocs(
    query(collection(db,"siswa"),where("rombelId","==",rombelEl.value))
  );
  let data=[];
  snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,"id"));
  data.forEach(s=>siswaEl.innerHTML+=
    `<option value="${s.id}">${s.nama}</option>`
  );
};

/* HISTORY */
siswaEl.onchange=async()=>{
  historyEl.innerHTML="Memuat...";
  totalEl.innerText="0";

  const snap=await getDocs(
    query(collection(db,"lapor_subuh"),
      where("siswaId","==",siswaEl.value))
  );

  let total=0,data=[];
  snap.forEach(d=>{
    data.push(d.data());
    total+=d.data().nilai;
  });

  data.sort((a,b)=>`${b.tanggal} ${b.jam}`
    .localeCompare(`${a.tanggal} ${a.jam}`));

  if(!data.length){
    historyEl.innerHTML="Belum ada laporan";
    return;
  }

  historyEl.innerHTML="<ul>"+data
    .map(r=>`<li>${r.tanggal} ${r.jam} ‚Üí ${r.nilai}</li>`)
    .join("")+"</ul>";
  totalEl.innerText=total;
};

/* KIRIM */
btnKirim.onclick=async()=>{
  errorEl.innerText="";
  noticeEl.style.display="none";

  if(!siswaEl.value){errorEl.innerText="Pilih siswa";return;}
  if(!validSubuh()){
    noticeEl.innerText="‚è∞ Hanya 03.00‚Äì05.00";
    noticeEl.style.display="block";
    return;
  }

  btnKirim.disabled=true;

  try{
    const docId=`${siswaEl.value}_${tanggalEl.value}`;
    const ref=doc(db,"lapor_subuh",docId);

    if((await getDoc(ref)).exists()){
      noticeEl.innerText="üôè Sudah lapor hari ini";
      noticeEl.style.display="block";
      return;
    }

    await setDoc(ref,{
      lembagaId:lembagaEl.value,
      lembagaNama:textOf(lembagaEl),
      kelasId:kelasEl.value,
      kelasNama:textOf(kelasEl),
      rombelId:rombelEl.value,
      rombelNama:textOf(rombelEl),
      siswaId:siswaEl.value,
      nama:textOf(siswaEl),
      tanggal:tanggalEl.value,
      bulan:tanggalEl.value.slice(0,7),
      jam:jamEl.value,
      nilai:5,
      dibuat:serverTimestamp()
    });

    await siswaEl.onchange();
    alert("‚úÖ Laporan berhasil");
    startCooldown(200); // ‚Üê cooldown kembali
  } finally {
    if(!localStorage.getItem(COOLDOWN_KEY)){
      btnKirim.disabled=false;
      btnKirim.innerText="Kirim Laporan";
    }
  }
};
</script>
</body>
</html>
