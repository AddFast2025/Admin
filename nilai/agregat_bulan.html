<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Nilai Bulanan Per Kelas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial;
  background:#f4f6f8;
  padding:20px;
}
.card{
  max-width:1000px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
}
h2{text-align:center}
label{font-weight:bold;display:block;margin-top:10px}
select,input,button{width:100%;padding:8px;margin-top:5px}
button{background:#2e7d32;color:#fff;border:none;margin-top:15px;cursor:pointer}

#btnPdf{
  background:#0d47a1;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
}
th{
  background:#1565c0;
  color:white;
}

td:nth-child(3){
  text-align:center;
  width:60px;
}

td:nth-child(1){
  text-align:center;
  width:40px;
}

.nama{
  font-size:15px;
  font-weight:bold;
}
.rincian{
  font-size:13px;
  color:#444;
  margin-top:4px;
}
.loading{
  text-align:center;
  margin-top:15px;
  font-weight:bold;
}

/* Area PDF */
.pdf-header{
  text-align:center;
  margin-bottom:10px;
  display:none;
}
.pdf-header h3{
  margin:0;
}
.pdf-info{
  font-size:13px;
  margin-top:5px;
}
</style>
</head>

<body>

<div class="card" id="areaPdf">

<!-- HEADER PDF -->
<div class="pdf-header" id="pdfHeader">
  <h3>üìä Rekap Nilai Bulanan</h3>
  <div class="pdf-info" id="pdfInfo"></div>
</div>

<h2>üìä Rekap Nilai Bulanan Per Kelas</h2>

<label>Bulan</label>
<input type="month" id="bulan">

<label>Lembaga</label>
<select id="lembaga"></select>

<label>Kelas</label>
<select id="kelas"></select>

<label>Rombel</label>
<select id="rombel"></select>

<button id="btn">Tampilkan Rekap</button>
<button id="btnPdf" style="display:none">‚¨áÔ∏è Download PDF</button>

<div id="loading" class="loading"></div>

<table id="tabel" style="display:none">
<thead>
<tr>
  <th>No</th>
  <th>Nama & Nilai</th>
  <th>Jumlah</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, getDocs, query, where 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= ELEMENT ================= */
const bulanEl   = document.getElementById("bulan");
const lembagaEl = document.getElementById("lembaga");
const kelasEl   = document.getElementById("kelas");
const rombelEl  = document.getElementById("rombel");
const tbody     = document.getElementById("tbody");
const tabel     = document.getElementById("tabel");
const loading   = document.getElementById("loading");
const btnPdf    = document.getElementById("btnPdf");
const areaPdf   = document.getElementById("areaPdf");
const pdfHeader = document.getElementById("pdfHeader");
const pdfInfo   = document.getElementById("pdfInfo");

/* ================= DEFAULT BULAN ================= */
const now = new Date();
bulanEl.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;

/* ================= LOAD LEMBAGA ================= */
async function loadLembaga(){
  const snap = await getDocs(collection(db,"lembaga"));
  lembagaEl.innerHTML = `<option value="">Pilih Lembaga</option>`;
  snap.forEach(d=>{
    lembagaEl.innerHTML += `<option value="${d.id}">${d.data().nama}</option>`;
  });
}
loadLembaga();

/* ================= LEMBAGA ‚Üí KELAS ================= */
lembagaEl.onchange = async ()=>{
  kelasEl.innerHTML = `<option value="">Pilih Kelas</option>`;
  rombelEl.innerHTML = `<option value="">Pilih Rombel</option>`;
  if(!lembagaEl.value) return;

  const snap = await getDocs(query(
    collection(db,"kelas"),
    where("lembagaId","==",lembagaEl.value)
  ));

  snap.forEach(d=>{
    kelasEl.innerHTML += `<option value="${d.id}">${d.data().nama}</option>`;
  });
};

/* ================= KELAS ‚Üí ROMBEL ================= */
kelasEl.onchange = async ()=>{
  rombelEl.innerHTML = `<option value="">Pilih Rombel</option>`;
  if(!kelasEl.value) return;

  const snap = await getDocs(query(
    collection(db,"rombel"),
    where("kelasId","==",kelasEl.value)
  ));

  snap.forEach(d=>{
    rombelEl.innerHTML += `<option value="${d.id}">${d.data().nama}</option>`;
  });
};

/* ================= BUTTON CLICK ================= */
document.getElementById("btn").onclick = async ()=>{

  tbody.innerHTML="";
  tabel.style.display="none";
  btnPdf.style.display="none";

  if(!bulanEl.value || !lembagaEl.value || !kelasEl.value || !rombelEl.value){
    loading.textContent="‚ö†Ô∏è Lengkapi pilihan terlebih dahulu";
    return;
  }

  loading.textContent="‚è≥ Memuat data...";

  const [y,m] = bulanEl.value.split("-");
  const start = `${y}-${m}-01`;
  const end   = `${y}-${m}-31`;

  /* ===== 1. Ambil siswa ===== */
  const siswaSnap = await getDocs(query(
    collection(db,"siswa"),
    where("rombelId","==",rombelEl.value)
  ));

  const siswaMap = {};
  siswaSnap.forEach(d=>{
    siswaMap[d.id] = {
      nama: d.data().nama,
      jamaah: 0,
      lapor: 0,
      pagi: 0,
      total: 0
    };
  });

  /* ===== 2. Loader nilai ===== */
 async function loadNilai(colName, field){

  const snap = await getDocs(query(
    collection(db,colName),
    where("lembagaId","==",lembagaEl.value),
    where("kelasId","==",kelasEl.value),
    where("rombelId","==",rombelEl.value)
  ));

  const startDate = new Date(start);
  const endDate   = new Date(end);

  snap.forEach(d=>{
    const r = d.data();
    if(!r.dibuat) return;
    const tgl = r.dibuat.toDate();

    if(tgl >= startDate && tgl <= endDate){
      if(siswaMap[r.siswaId]){
        siswaMap[r.siswaId][field] += r.nilai;
        siswaMap[r.siswaId].total += r.nilai;
      }
    }
  });
}

  /* ===== 3. Ambil 3 koleksi ===== */
  await Promise.all([
    loadNilai("absen_jamaah_subuh","jamaah"),
    loadNilai("lapor_subuh","lapor"),
    loadNilai("absen_pagi","pagi"),
  ]);

  /* ===== 4. Render ===== */
  const hasil = Object.values(siswaMap)
    .sort((a,b)=>b.total - a.total);

  let no = 1;
  hasil.forEach(r=>{
    tbody.innerHTML += `
      <tr>
        <td>${no++}</td>
        <td>
          <div class="nama">${r.nama}</div>
          <div class="rincian">
            Jamaah ${r.jamaah} + 
            Subuh ${r.lapor} + 
            Absen ${r.pagi}
          </div>
        </td>
        <td><b>${r.total}</b></td>
      </tr>`;
  });

  loading.textContent = hasil.length
    ? "‚úÖ Data berhasil dimuat"
    : "‚ö†Ô∏è Data kosong";

  tabel.style.display="table";
  btnPdf.style.display = hasil.length ? "block" : "none";

  /* ===== INFO PDF ===== */
  const lembagaText = lembagaEl.options[lembagaEl.selectedIndex].text;
  const kelasText   = kelasEl.options[kelasEl.selectedIndex].text;
  const rombelText  = rombelEl.options[rombelEl.selectedIndex].text;

  pdfInfo.innerHTML = `
    Bulan: <b>${bulanEl.value}</b> |
    Lembaga: <b>${lembagaText}</b> |
    Kelas: <b>${kelasText} ${rombelText}</b>
  `;
};

/* ================= PDF DOWNLOAD ================= */
btnPdf.onclick = () => {

  pdfHeader.style.display = "block";

  const kelasText = kelasEl.options[kelasEl.selectedIndex].text;
  const rombelText = rombelEl.options[rombelEl.selectedIndex].text;

  const filename = `Rekap_${bulanEl.value}_${kelasText}_${rombelText}.pdf`
                    .replace(/\s+/g,"_");

  const opt = {
    margin: 8,
    filename: filename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS:true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(areaPdf).save()
    .then(()=>{
      pdfHeader.style.display = "none";
    });
};
</script>

<!-- PDF LIBRARY -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</body>
</html>
