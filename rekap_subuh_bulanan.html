<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Ranking Lapor Subuh Bulanan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:8px; }

label { font-weight:bold; display:block; margin-top:10px; }
select,input,button { width:100%; padding:8px; margin-top:5px; }

button {
  background:#1565c0;
  color:white;
  border:none;
  margin-top:15px;
  cursor:pointer;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:25px;
}
th,td {
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th {
  background:#2e7d32;
  color:white;
}
</style>
</head>

<body>

<div class="card">
<h2 align="center">üèÜ Ranking Lapor Subuh Bulanan</h2>

<label>Bulan</label>
<input type="month" id="bulan">

<label>Lembaga</label>
<select id="lembaga"><option value="">Pilih</option></select>

<label>Kelas</label>
<select id="kelas"><option value="">Pilih</option></select>

<label>Rombel</label>
<select id="rombel"><option value="">Pilih</option></select>

<button onclick="loadData()">Tampilkan</button>
<button onclick="downloadPDF()">‚¨á Download PDF</button>

<table id="rankTable" style="display:none">
<thead>
<tr>
  <th>No</th>
  <th>Nama</th>
  <th>Nilai</th>
</tr>
</thead>
<tbody id="rankBody"></tbody>
</table>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const bulanEl = document.getElementById("bulan");
// set default bulan sekarang (AMAN, tidak konflik)
const now = new Date();
bulanEl.value =
  now.getFullYear() + "-" +
  String(now.getMonth() + 1).padStart(2, "0");


const lembagaEl = document.getElementById("lembaga");
const kelasEl   = document.getElementById("kelas");
const rombelEl  = document.getElementById("rombel");
const rankBody  = document.getElementById("rankBody");
const rankTable = document.getElementById("rankTable");

let dataPDF = [];

/* LOAD LEMBAGA */
const snapL = await getDocs(collection(db,"lembaga"));
snapL.forEach(d=>{
  lembagaEl.innerHTML+=`<option value="${d.id}">${d.data().nama}</option>`;
});

/* LOAD KELAS */
lembagaEl.onchange = async ()=>{
  kelasEl.innerHTML='<option value="">Pilih</option>';
  rombelEl.innerHTML='<option value="">Pilih</option>';
  const s = await getDocs(query(collection(db,"kelas"), where("lembagaId","==",lembagaEl.value)));
  s.forEach(d=>kelasEl.innerHTML+=`<option value="${d.id}">${d.data().nama}</option>`);
};

/* LOAD ROMBEL */
kelasEl.onchange = async ()=>{
  rombelEl.innerHTML='<option value="">Pilih</option>';
  const s = await getDocs(query(collection(db,"rombel"), where("kelasId","==",kelasEl.value)));
  s.forEach(d=>rombelEl.innerHTML+=`<option value="${d.id}">${d.data().nama}</option>`);
};

/* LOAD DATA */
window.loadData = async ()=>{
  rankBody.innerHTML="";
  dataPDF = [];

  const bulan = document.getElementById("bulan").value;

  if(!bulan || !rombelEl.value){
    alert("Lengkapi filter");
    return;
  }

  const siswaSnap = await getDocs(query(
    collection(db,"siswa"),
    where("rombelId","==",rombelEl.value)
  ));

  const map = {};
  siswaSnap.forEach(s=>{
    map[s.id]={ nama:s.data().nama, nilai:0 };
  });

  const laporSnap = await getDocs(query(
    collection(db,"lapor_subuh"),
    where("bulan","==",bulan),
    where("rombelId","==",rombelEl.value)
  ));

  laporSnap.forEach(d=>{
    const r=d.data();
    if(map[r.siswaId]) map[r.siswaId].nilai += r.nilai;
  });

  const arr = Object.values(map).sort((a,b)=>b.nilai-a.nilai);

  arr.forEach((r,i)=>{
    rankBody.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td style="text-align:left">${r.nama}</td>
        <td>${r.nilai}</td>
      </tr>`;
    dataPDF.push({ no:i+1, nama:r.nama, nilai:r.nilai });
  });

  rankTable.style.display="table";
};

/* DOWNLOAD PDF */
window.downloadPDF = ()=>{
  if(!dataPDF.length) return alert("Data kosong");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"px", format:[250,800] });

// ===== WAKTU UPDATE =====
const now = new Date();
const tgl = now.toLocaleDateString("id-ID", {
  day:"2-digit", month:"long", year:"numeric"
});
const jam = now.toLocaleTimeString("id-ID", {
  hour:"2-digit", minute:"2-digit"
});


  const bulanTxt   = document.getElementById("bulan").value;
  const lembagaTxt = lembagaEl.options[lembagaEl.selectedIndex].text;
  const kelasTxt   = kelasEl.options[kelasEl.selectedIndex].text;
  const rombelTxt  = rombelEl.options[rombelEl.selectedIndex].text;

let y = 14;

// header kecil update
doc.setFontSize(9);
doc.setTextColor(120);
doc.text(`Update data: ${tgl} ‚Ä¢ ${jam}`, 150, y, { align:"center" });

y += 14; // jarak ke judul utama
doc.setTextColor(0);


  /* ===== JUDUL ===== */
  doc.setFontSize(13);
  doc.text(`Rekap Subuh Bulanan : ${bulanTxt}`, 10, y, {align:"left"});
  y += 14;

  doc.setFontSize(13);
  doc.text(`${lembagaTxt}`, 10, y); y += 14;
  doc.text(`Kelas / Rombel : ${kelasTxt} / ${rombelTxt}`, 10, y); y += 18;

  /* ===== HEADER TABEL ===== */
  doc.setFillColor(46,125,50); // hijau
  doc.rect(10, y-12, 280, 14, "F");

  doc.setTextColor(255);
  doc.setFontSize(13);
  doc.text("No",   10, y);
  doc.text("Nama", 30, y);
  doc.text("Nilai",220, y, {align:"left"});

  doc.setTextColor(0);
  y += 16;

  /* ===== ISI TABEL ===== */
  dataPDF.forEach((r,i)=>{
    // warna selang-seling
    if(i % 2 === 0){
      doc.setFillColor(245,247,250); // abu muda
      doc.rect(10, y-12, 280, 14, "F");
    }
if(r.nilai === 0){
  doc.setTextColor(211,47,47); // merah
}else{
  doc.setTextColor(0,0,0);    // hitam
}


    doc.text(String(r.no), 10, y);
    doc.text(r.nama, 30, y);
    doc.text(String(r.nilai), 220, y, {align:"left"});

    y += 16;

    // auto halaman baru
    if(y > 780){
      doc.addPage();
      y = 20;
    }
  });

  doc.save(`${kelasTxt}${rombelTxt} ${bulanTxt} Rekap_Subuh_ ${lembagaTxt}.pdf`);
  alert("‚úÖ File PDF berhasil di-download");
const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
audio.play();
};
</script>

</body>
</html>
