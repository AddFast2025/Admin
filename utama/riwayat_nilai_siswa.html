<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Riwayat Nilai Siswa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial;
  background:#f4f6f8;
  padding:20px;
}
.card{
  max-width:900px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
}
h2{
  text-align:center;
}
label{
  font-weight:bold;
  display:block;
  margin-top:10px;
}
select,input,button{
  width:100%;
  padding:8px;
  margin-top:5px;
}
button{
  background:#2e7d32;
  color:#fff;
  border:none;
  margin-top:15px;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
}
th{
  background:#1565c0;
  color:white;
}
td:nth-child(1),
td:nth-child(3){
  text-align:center;
  width:80px;
}
.section-title{
  margin-top:30px;
  font-weight:bold;
}
.loading{
  text-align:center;
  margin-top:15px;
  color:#555;
}
.sum{
  font-weight:bold;
  background:#f1f8e9;
}
</style>
</head>

<body>

<div class="card">
<h2>ðŸ“Š Riwayat Nilai Siswa</h2>

<label>Bulan</label>
<input type="month" id="bulan">

<label>Lembaga</label>
<select id="lembaga"></select>

<label>Kelas</label>
<select id="kelas"></select>

<label>Rombel</label>
<select id="rombel"></select>

<label>Nama Siswa</label>
<select id="siswa"></select>

<button id="btn">Tampilkan Riwayat</button>

<div id="loading" class="loading"></div>

<!-- JAMAAH SUBUH -->
<div class="section-title">ðŸ•Œ Riwayat Jamaah Subuh</div>
<table id="tabelJamaah" style="display:none">
<thead>
<tr><th>No</th><th>Tanggal</th><th>Nilai</th></tr>
</thead>
<tbody id="tbodyJamaah"></tbody>
</table>

<!-- LAPOR SUBUH -->
<div class="section-title">ðŸ“¿ Riwayat Lapor Subuh</div>
<table id="tabelLapor" style="display:none">
<thead>
<tr><th>No</th><th>Tanggal</th><th>Nilai</th></tr>
</thead>
<tbody id="tbodyLapor"></tbody>
</table>

<!-- ABSEN PAGI -->
<div class="section-title">ðŸŒ… Riwayat Absen Pagi</div>
<table id="tabelPagi" style="display:none">
<thead>
<tr><th>No</th><th>Tanggal</th><th>Nilai</th></tr>
</thead>
<tbody id="tbodyPagi"></tbody>
</table>



<div id="grandTotal" 
     style="margin-top:25px;
            font-weight:bold;
            font-size:20px;
color:#1565c0;
            text-align:center;
            display:none">
  Jumlah Total : <span id="totalAll">0</span>
</div>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ELEMENT */
const bulanEl = document.getElementById("bulan");
const lembagaEl = document.getElementById("lembaga");
const kelasEl = document.getElementById("kelas");
const rombelEl = document.getElementById("rombel");
const siswaEl = document.getElementById("siswa");
const loading = document.getElementById("loading");

const tbodyJamaah = document.getElementById("tbodyJamaah");
const tbodyLapor  = document.getElementById("tbodyLapor");
const tbodyPagi   = document.getElementById("tbodyPagi");

/* BULAN DEFAULT */
const now = new Date();
bulanEl.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;

/* LOAD LEMBAGA */
async function loadLembaga(){
  lembagaEl.innerHTML='<option value="">-- Pilih Lembaga --</option>';
  const snap = await getDocs(collection(db,"lembaga"));
  snap.forEach(d=>{
    lembagaEl.innerHTML += `<option value="${d.id}">${d.data().nama}</option>`;
  });
}
loadLembaga();

/* LEMBAGA â†’ KELAS */
lembagaEl.onchange = async ()=>{
  kelasEl.innerHTML='<option value="">-- Pilih Kelas --</option>';
  rombelEl.innerHTML='<option value="">-- Pilih Rombel --</option>';
  siswaEl.innerHTML='<option value="">-- Pilih Nama --</option>';
  if(!lembagaEl.value) return;

  const snap = await getDocs(query(
    collection(db,"kelas"),
    where("lembagaId","==",lembagaEl.value)
  ));
  snap.forEach(d=>{
    kelasEl.innerHTML += `<option value="${d.id}">${d.data().nama}</option>`;
  });
};

/* KELAS â†’ ROMBEL */
kelasEl.onchange = async ()=>{
  rombelEl.innerHTML='<option value="">-- Pilih Rombel --</option>';
  siswaEl.innerHTML='<option value="">-- Pilih Nama --</option>';
  if(!kelasEl.value) return;

  const snap = await getDocs(query(
    collection(db,"rombel"),
    where("kelasId","==",kelasEl.value)
  ));
  snap.forEach(d=>{
    rombelEl.innerHTML += `<option value="${d.id}">${d.data().nama}</option>`;
  });
};

/* ROMBEL â†’ SISWA */
rombelEl.onchange = async ()=>{
  siswaEl.innerHTML='<option value="">-- Pilih Nama --</option>';
  if(!rombelEl.value) return;

  const snap = await getDocs(query(
    collection(db,"siswa"),
    where("rombelId","==",rombelEl.value)
  ));
  snap.forEach(d=>{
    siswaEl.innerHTML += `<option value="${d.id}">${d.data().nama}</option>`;
  });
};


let totalJamaah = 0;
let totalLapor  = 0;
let totalPagi   = 0;


/* FUNGSI UMUM LOAD RIWAYAT */
async function loadRiwayat(namaCollection, tbody, tabelId){
  tbody.innerHTML="";
  let total = 0;
  let no = 1;

  const [y,m] = bulanEl.value.split("-");
  const start = `${y}-${m}-01`;
  const end   = `${y}-${m}-31`;

  const snap = await getDocs(query(
    collection(db, namaCollection),
    where("siswaId","==",siswaEl.value),
    where("tanggal",">=",start),
    where("tanggal","<=",end)
  ));

  snap.forEach(d=>{
    const r = d.data();
    if(
      r.lembagaId === lembagaEl.value &&
      r.kelasId === kelasEl.value &&
      r.rombelId === rombelEl.value
    ){
      total += r.nilai;
      tbody.innerHTML += `
        <tr>
          <td>${no++}</td>
          <td>${r.tanggal}</td>
          <td>${r.nilai}</td>
        </tr>`;
    }
  });

  tbody.innerHTML += `
    <tr class="sum">
      <td colspan="2" style="text-align:right">Jumlah</td>
      <td style="text-align:center">${total}</td>
    </tr>
  `;

document.getElementById(tabelId).style.display="table";
return total;

}

/* TOMBOL */
document.getElementById("btn").onclick = async ()=>{
  if(!bulanEl.value || !lembagaEl.value || !kelasEl.value || !rombelEl.value || !siswaEl.value){
    loading.textContent="Lengkapi pilihan terlebih dahulu";
    return;
  }

  loading.textContent="Memuat data...";

totalJamaah = await loadRiwayat(
  "absen_jamaah_subuh", tbodyJamaah, "tabelJamaah"
);

totalLapor = await loadRiwayat(
  "lapor_subuh", tbodyLapor, "tabelLapor"
);

totalPagi = await loadRiwayat(
  "absen_pagi", tbodyPagi, "tabelPagi"
);

const grand = totalJamaah + totalLapor + totalPagi;

document.getElementById("totalAll").textContent = grand;
document.getElementById("grandTotal").style.display = "block";


  loading.textContent="";
};
</script>

</body>
</html>
