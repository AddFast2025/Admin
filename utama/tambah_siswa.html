<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Input Siswa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
label { font-weight:bold; display:block; margin-top:12px; }
select,textarea,button { width:100%; padding:8px; margin-top:5px; }
textarea { resize:vertical; }
button { background:#2e7d32; color:white; border:none; margin-top:15px; cursor:pointer; }
ul { padding-left:18px; margin-top:10px; }
li { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.hapus {
  background:#c62828;
  color:#fff;
  border:none;
  width:22px;
  height:22px;
  font-size:12px;
  border-radius:50%;
  cursor:pointer;
}
.error { color:#c62828; margin-top:10px; }
.ket { font-size:12px; color:#555; margin-top:4px; }
hr { margin:20px 0; }
</style>
</head>

<body>

<div class="card">
<h2 align="center">Input Siswa</h2>

<label>Lembaga</label>
<select id="lembaga"></select>

<div id="infoJumlah" class="ket">
Telah tersedia 0 siswa (jumlah siswa saat ini)
</div>

<label>Kelas</label>
<select id="kelas"></select>

<label>Rombel</label>
<select id="rombel"></select>

<label>Nama Siswa (1 nama per baris)</label>
<textarea id="nama" rows="6" placeholder="Contoh:
Ahmad Fawwaz
Sri Lastutik
Muhammad Nurzakun"></textarea>
<div class="ket">?? Satu nama per baris</div>

<button onclick="simpan()">Simpan Semua Siswa</button>
<div id="error" class="error"></div>

<hr>
<h3>Daftar Siswa</h3>
<div id="list">Pilih rombel</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, where, deleteDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ELEMENT */
const lembagaEl = document.getElementById("lembaga");
const kelasEl   = document.getElementById("kelas");
const rombelEl  = document.getElementById("rombel");
const listEl    = document.getElementById("list");
const infoJumlahEl = document.getElementById("infoJumlah");

/* LOAD LEMBAGA */
async function loadLembaga(){
  lembagaEl.innerHTML = "<option value=''>Pilih Lembaga</option>";
  const snap = await getDocs(collection(db,"lembaga"));
  snap.forEach(d=>{
    const o = document.createElement("option");
    o.value = d.id;
    o.textContent = d.data().nama;
    lembagaEl.appendChild(o);
  });
}
loadLembaga();

/* TAMPILKAN JUMLAH SISWA */
async function tampilkanJumlahSiswa(lembagaId){
  if(!lembagaId){
    infoJumlahEl.innerText = "Telah tersedia 0 siswa (jumlah siswa saat ini)";
    return;
  }
  const ref = doc(db,"lembaga",lembagaId);
  const snap = await getDocs(
    query(collection(db,"lembaga"), where("__name__","==",lembagaId))
  );
  snap.forEach(d=>{
    const jml = d.data().jumlahSiswa || 0;
    infoJumlahEl.innerText =
      `Telah tersedia ${jml} siswa (jumlah siswa saat ini)`;
  });
}

/* LOAD KELAS */
lembagaEl.onchange = async ()=>{
  tampilkanJumlahSiswa(lembagaEl.value);

  kelasEl.innerHTML = "<option value=''>Pilih Kelas</option>";
  rombelEl.innerHTML = "<option value=''>Pilih Rombel</option>";
  listEl.innerHTML = "Pilih rombel";
  if(!lembagaEl.value) return;

  const snap = await getDocs(
    query(collection(db,"kelas"), where("lembagaId","==",lembagaEl.value))
  );
  snap.forEach(d=>{
    const o = document.createElement("option");
    o.value = d.id;
    o.textContent = d.data().nama;
    kelasEl.appendChild(o);
  });
};

/* LOAD ROMBEL */
kelasEl.onchange = async ()=>{
  rombelEl.innerHTML = "<option value=''>Pilih Rombel</option>";
  listEl.innerHTML = "Pilih rombel";
  if(!kelasEl.value) return;

  const snap = await getDocs(
    query(collection(db,"rombel"), where("kelasId","==",kelasEl.value))
  );
  snap.forEach(d=>{
    const o = document.createElement("option");
    o.value = d.id;
    o.textContent = d.data().nama;
    rombelEl.appendChild(o);
  });
};

/* LOAD SISWA */
rombelEl.onchange = loadSiswa;

async function loadSiswa(){
  listEl.innerHTML = "Memuat data...";
  if(!rombelEl.value) return;

  const snap = await getDocs(
    query(collection(db,"siswa"), where("rombelId","==",rombelEl.value))
  );

  if(snap.empty){
    listEl.innerHTML = "Belum ada siswa";
    return;
  }

  let html = "<ul>";
  snap.forEach(d=>{
    html += `
      <li>
        <span>${d.data().nama}</span>
        <button class="hapus"
          onclick="hapusSiswa('${d.id}','${d.data().nama}')">Ã—</button>
      </li>`;
  });
  html += "</ul>";
  listEl.innerHTML = html;
}

/* UPDATE JUMLAH SISWA LEMBAGA */
async function updateJumlahSiswaLembaga(lembagaId){
  let total = 0;
  const kelasSnap = await getDocs(
    query(collection(db,"kelas"), where("lembagaId","==",lembagaId))
  );

  for(const k of kelasSnap.docs){
    const rombelSnap = await getDocs(
      query(collection(db,"rombel"), where("kelasId","==",k.id))
    );
    for(const r of rombelSnap.docs){
      const siswaSnap = await getDocs(
        query(collection(db,"siswa"), where("rombelId","==",r.id))
      );
      total += siswaSnap.size;
    }
  }

  await updateDoc(doc(db,"lembaga",lembagaId), {
    jumlahSiswa: total
  });
}

/* SIMPAN SISWA */
window.simpan = async ()=>{
  const error = document.getElementById("error");
  error.innerText = "";

  if(!lembagaEl.value || !kelasEl.value || !rombelEl.value){
    error.innerText = "Lembaga, kelas, dan rombel wajib dipilih";
    return;
  }

  const teks = document.getElementById("nama").value.trim();
  if(!teks){
    error.innerText = "Nama siswa wajib diisi";
    return;
  }

  const daftarNama = teks.split("\n").map(n=>n.trim()).filter(n=>n);

  for(const nama of daftarNama){
    await addDoc(collection(db,"siswa"),{
      lembagaId: lembagaEl.value,
      kelasId: kelasEl.value,
      rombelId: rombelEl.value,
      nama,
      dibuat: new Date()
    });
  }

  document.getElementById("nama").value = "";
  await updateJumlahSiswaLembaga(lembagaEl.value);
  tampilkanJumlahSiswa(lembagaEl.value);
  loadSiswa();

  alert(`Berhasil menambahkan ${daftarNama.length} siswa`);
};

/* HAPUS SISWA */
window.hapusSiswa = async (id,nama)=>{
  if(!confirm(`Hapus siswa ${nama}?`)) return;

  await deleteDoc(doc(db,"siswa",id));
  await updateJumlahSiswaLembaga(lembagaEl.value);
  tampilkanJumlahSiswa(lembagaEl.value);
  loadSiswa();
};
</script>

</body>
</html>
